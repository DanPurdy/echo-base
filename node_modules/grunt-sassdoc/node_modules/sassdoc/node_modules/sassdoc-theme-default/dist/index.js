"use strict";

var _to5Helpers = require("6to5-runtime/helpers");

var _core = require("6to5-runtime/core-js");

var chroma = _to5Helpers.interopRequire(require("chroma-js"));

var def = _to5Helpers.interopRequire(require("../default"));

var denodeify = _to5Helpers.interopRequire(require("promise-denodeify"));

var extend = _to5Helpers.interopRequire(require("extend"));

var fs = _to5Helpers.interopRequire(require("fs"));

var fse = _to5Helpers.interopRequire(require("fs-extra"));

var minify = require("html-minifier").minify;
var path = _to5Helpers.interopRequire(require("path"));

var sassdocExtras = _to5Helpers.interopRequire(require("sassdoc-extras"));

var swig = _to5Helpers.interopRequire(require("./swig"));

var copy = denodeify(fse.copy, _core.Promise);
var renderFile = denodeify(swig.renderFile, _core.Promise);
var writeFile = denodeify(fs.writeFile, _core.Promise);

var applyDefaults = function (ctx) {
  return extend({}, def, ctx, {
    groups: extend(def.groups, ctx.groups),
    display: extend(def.display, ctx.display) });
};

var shortcutIcon = function (dest, ctx) {
  if (!ctx.shortcutIcon) {
    ctx.shortcutIcon = { type: "internal", url: "assets/images/favicon.png" };
  } else if (ctx.shortcutIcon.type === "internal") {
    ctx.shortcutIcon.url = "assets/images/" + ctx.shortcutIcon.url;

    return function () {
      return copy(ctx.shortcutIcon.path, path.resolve(dest, ctx.shortcutIcon.url));
    };
  }
};

module.exports = function (dest, ctx) {
  ctx = applyDefaults(ctx);

  sassdocExtras.markdown(ctx);
  sassdocExtras.display(ctx);
  sassdocExtras.groupName(ctx);
  sassdocExtras.shortcutIcon(ctx);

  ctx.data.byGroupAndType = sassdocExtras.byGroupAndType(ctx.data);

  var index = path.resolve(__dirname, "../views/documentation/index.html.swig");

  return _core.Promise.all([copy(path.resolve(__dirname, "../assets"), path.resolve(dest, "assets")).then(shortcutIcon(dest, ctx)), renderFile(index, ctx).then(function (html) {
    return minify(html, { collapseWhitespace: true });
  }).then(function (html) {
    return writeFile(path.resolve(dest, "index.html"), html);
  })]);
};
